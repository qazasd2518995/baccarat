generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  agent
  member
}

enum UserStatus {
  active
  suspended
  banned
}

enum TransactionType {
  deposit
  withdraw
  bet
  win
  refund
  adjustment
}

enum BetType {
  // Baccarat
  player
  banker
  tie
  player_pair
  banker_pair
  super_six
  player_bonus
  banker_bonus
  big
  small

  // Dragon Tiger
  dragon
  tiger
  dt_tie
  dt_suited_tie
  dragon_big
  dragon_small
  tiger_big
  tiger_small
  dragon_odd
  dragon_even
  tiger_odd
  tiger_even
  dragon_red
  dragon_black
  tiger_red
  tiger_black

  // Bull Bull
  bb_banker
  bb_player1
  bb_player2
  bb_player3
}

enum BetStatus {
  pending
  won
  lost
  refunded
}

enum GameResult {
  player
  banker
  tie

  // Dragon Tiger results
  dragon
  tiger
  dt_tie
}

enum NoticeType {
  info
  warning
  urgent
}

enum NoticeDisplayTarget {
  agent_dashboard
  game_marquee
  both
}

model User {
  id              String      @id @default(uuid())
  username        String      @unique
  passwordHash    String      @map("password_hash")
  nickname        String?
  role            UserRole
  parentAgentId   String?     @map("parent_agent_id")
  parentAgent     User?       @relation("AgentHierarchy", fields: [parentAgentId], references: [id])
  subUsers        User[]      @relation("AgentHierarchy")
  balance         Decimal     @default(0) @db.Decimal(15, 2)
  status          UserStatus  @default(active)
  bettingLimitId  String?     @map("betting_limit_id")
  bettingLimit    BettingLimit? @relation(fields: [bettingLimitId], references: [id])
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // 新增代理層級相關欄位
  agentLevel      Int         @default(5) @map("agent_level")  // 代理層級 1-5
  inviteCode      String?     @unique @map("invite_code")      // 邀請碼
  sharePercent    Decimal     @default(0) @map("share_percent") @db.Decimal(5, 2)  // 佔成比例
  rebatePercent   Decimal     @default(0) @map("rebate_percent") @db.Decimal(5, 2) // 退水比例
  isLocked        Boolean     @default(false) @map("is_locked")          // 鎖定登入
  isFullDisabled  Boolean     @default(false) @map("is_full_disabled")   // 全線禁用
  isReadonly      Boolean     @default(false) @map("is_readonly")        // 禁止投注/操作
  lastLoginIp     String?     @map("last_login_ip")            // 最後登入IP
  lastLoginAt     DateTime?   @map("last_login_at")            // 最後登入時間

  transactionsAsUser     Transaction[]    @relation("UserTransactions")
  transactionsAsOperator Transaction[]    @relation("OperatorTransactions")
  bets                   Bet[]
  depositControl         DepositControl?
  winCapControl          WinCapControl?
  agentLineWinCap        AgentLineWinCap?
  createdNotices         Notice[]
  operationLogs          OperationLog[]
  chatMessages           ChatMessage[]
  giftTransactions       GiftTransaction[]
  dealerFollows          DealerFollow[]
  notificationSettings   NotificationSettings?

  // 新增關聯
  agentShareSettings     AgentShareSetting[]
  agentBetLimits         AgentBetLimit[]
  subAccounts            SubAccount[]
  loginLogs              LoginLog[]

  @@map("users")
}

model Transaction {
  id            String          @id @default(uuid())
  userId        String          @map("user_id")
  user          User            @relation("UserTransactions", fields: [userId], references: [id])
  operatorId    String          @map("operator_id")
  operator      User            @relation("OperatorTransactions", fields: [operatorId], references: [id])
  type          TransactionType
  amount        Decimal         @db.Decimal(15, 2)
  balanceBefore Decimal         @map("balance_before") @db.Decimal(15, 2)
  balanceAfter  Decimal         @map("balance_after") @db.Decimal(15, 2)
  note          String?
  createdAt     DateTime        @default(now()) @map("created_at")

  @@map("transactions")
}

model GameRound {
  id           String      @id @default(uuid())
  roundNumber  String      @map("round_number")  // Format: YYYYMMDDNNN (e.g., 20260228001)
  shoeNumber   Int         @default(1) @map("shoe_number")
  tableId      String?     @map("table_id")
  table        GameTable?  @relation(fields: [tableId], references: [id])
  playerCards  Json        @map("player_cards")
  bankerCards  Json        @map("banker_cards")
  playerPoints Int         @map("player_points")
  bankerPoints Int         @map("banker_points")
  result       GameResult
  playerPair   Boolean     @default(false) @map("player_pair")
  bankerPair   Boolean     @default(false) @map("banker_pair")
  createdAt    DateTime    @default(now()) @map("created_at")

  bets Bet[]

  @@index([tableId, createdAt])
  @@map("game_rounds")
}

model Bet {
  id                 String              @id @default(uuid())
  userId             String              @map("user_id")
  user               User                @relation(fields: [userId], references: [id])
  roundId            String?             @map("round_id")
  round              GameRound?          @relation(fields: [roundId], references: [id])
  dragonTigerRoundId String?             @map("dragon_tiger_round_id")
  dragonTigerRound   DragonTigerRound?   @relation(fields: [dragonTigerRoundId], references: [id])
  bullBullRoundId    String?             @map("bull_bull_round_id")
  bullBullRound      BullBullRound?      @relation(fields: [bullBullRoundId], references: [id])
  betType            BetType             @map("bet_type")
  amount             Decimal             @db.Decimal(15, 2)
  payout             Decimal?            @db.Decimal(15, 2)
  status             BetStatus           @default(pending)
  createdAt          DateTime            @default(now()) @map("created_at")

  @@map("bets")
}

// Dragon Tiger game round
model DragonTigerRound {
  id          String     @id @default(uuid())
  roundNumber String     @map("round_number")  // Format: YYYYMMDDNNN (e.g., 20260228001)
  shoeNumber  Int        @default(1) @map("shoe_number")
  tableId     String?    @map("table_id")
  table       GameTable? @relation(fields: [tableId], references: [id])
  dragonCard  Json       @map("dragon_card")
  tigerCard   Json       @map("tiger_card")
  dragonValue Int        @map("dragon_value")
  tigerValue  Int        @map("tiger_value")
  result      GameResult
  isSuitedTie Boolean    @default(false) @map("is_suited_tie")
  createdAt   DateTime   @default(now()) @map("created_at")

  bets Bet[]

  @@index([tableId, createdAt])
  @@map("dragon_tiger_rounds")
}

// Bull Bull game round
model BullBullRound {
  id            String      @id @default(uuid())
  roundNumber   String      @map("round_number")  // Format: YYYYMMDDNNN (e.g., 20260228001)
  shoeNumber    Int         @default(1) @map("shoe_number")
  tableId       String?     @map("table_id")
  table         GameTable?  @relation(fields: [tableId], references: [id])
  bankerCards   Json        @map("banker_cards")
  player1Cards  Json     @map("player1_cards")
  player2Cards  Json     @map("player2_cards")
  player3Cards  Json     @map("player3_cards")
  bankerRank    String   @map("banker_rank")
  player1Rank   String   @map("player1_rank")
  player2Rank   String   @map("player2_rank")
  player3Rank   String   @map("player3_rank")
  player1Result String   @map("player1_result")
  player2Result String   @map("player2_result")
  player3Result String   @map("player3_result")
  createdAt     DateTime @default(now()) @map("created_at")

  bets Bet[]

  @@index([tableId, createdAt])
  @@map("bull_bull_rounds")
}

// Game state for persistence across server restarts (Baccarat)
model GameState {
  id             String   @id @default("singleton")
  shoeNumber     Int      @default(1) @map("shoe_number")
  roundCounter   Int      @default(0) @map("round_counter")
  cardsRemaining Int      @default(416) @map("cards_remaining")
  shuffledDeck   Json?    @map("shuffled_deck")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("game_state")
}

// Dragon Tiger game state
model DragonTigerGameState {
  id             String   @id @default("dt_singleton")
  shoeNumber     Int      @default(1) @map("shoe_number")
  roundCounter   Int      @default(0) @map("round_counter")
  cardsRemaining Int      @default(416) @map("cards_remaining")
  shuffledDeck   Json?    @map("shuffled_deck")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("dragon_tiger_game_state")
}

// Bull Bull game state
model BullBullGameState {
  id             String   @id @default("bb_singleton")
  shoeNumber     Int      @default(1) @map("shoe_number")
  roundCounter   Int      @default(0) @map("round_counter")
  cardsRemaining Int      @default(416) @map("cards_remaining")
  shuffledDeck   Json?    @map("shuffled_deck")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("bull_bull_game_state")
}

// 入金控制
model DepositControl {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  user      User     @relation(fields: [userId], references: [id])
  enabled   Boolean  @default(false)
  minAmount Decimal? @map("min_amount") @db.Decimal(15, 2)
  maxAmount Decimal? @map("max_amount") @db.Decimal(15, 2)
  note      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("deposit_controls")
}

// 會員輸贏控制（機率控制）
model WinCapControl {
  id                String   @id @default(uuid())
  userId            String   @unique @map("user_id")
  user              User     @relation(fields: [userId], references: [id])
  enabled           Boolean  @default(false)
  controlDirection  String   @default("win") @map("control_direction")  // 'win' = 讓他贏, 'lose' = 讓他輸
  controlPercentage Int      @default(50) @map("control_percentage")    // 控制機率 1-100%
  note              String?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("win_cap_controls")
}

// 代理線輸贏控制（機率控制）
model AgentLineWinCap {
  id                String   @id @default(uuid())
  agentId           String   @unique @map("agent_id")
  agent             User     @relation(fields: [agentId], references: [id])
  enabled           Boolean  @default(false)
  controlDirection  String   @default("win") @map("control_direction")  // 'win' = 讓線下贏, 'lose' = 讓線下輸
  controlPercentage Int      @default(50) @map("control_percentage")    // 控制機率 1-100%
  note              String?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("agent_line_win_caps")
}

// 公告
model Notice {
  id            String              @id @default(uuid())
  title         String
  content       String
  type          NoticeType          @default(info)
  displayTarget NoticeDisplayTarget @default(both) @map("display_target")
  isPinned      Boolean             @default(false) @map("is_pinned")
  isPublished   Boolean             @default(true) @map("is_published")
  createdBy     String              @map("created_by")
  creator       User                @relation(fields: [createdBy], references: [id])
  createdAt     DateTime            @default(now()) @map("created_at")
  updatedAt     DateTime            @updatedAt @map("updated_at")

  @@map("notices")
}

// 操作日誌
model OperationLog {
  id         String   @id @default(uuid())
  operatorId String   @map("operator_id")
  operator   User     @relation(fields: [operatorId], references: [id])
  action     String
  targetType String?  @map("target_type")
  targetId   String?  @map("target_id")
  details    Json?
  ipAddress  String?  @map("ip_address")
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("operation_logs")
}

// 聊天消息
model ChatMessage {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id])
  message   String
  createdAt DateTime @default(now()) @map("created_at")

  @@map("chat_messages")
}

// 禮物交易記錄
model GiftTransaction {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  user       User     @relation(fields: [userId], references: [id])
  dealerName String   @map("dealer_name")
  giftType   String   @map("gift_type")
  giftName   String   @map("gift_name")
  price      Decimal  @db.Decimal(15, 2)
  quantity   Int      @default(1)
  total      Decimal  @db.Decimal(15, 2)
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("gift_transactions")
}

// 遊戲桌台
model GameTable {
  id             String      @id @default(uuid())
  name           String
  dealerName     String      @map("dealer_name")
  dealerAvatar   String?     @map("dealer_avatar")
  gameType       String      @default("baccarat") @map("game_type")
  minBet         Decimal     @map("min_bet") @db.Decimal(15, 2)
  maxBet         Decimal     @map("max_bet") @db.Decimal(15, 2)
  isActive       Boolean     @default(true) @map("is_active")
  currentPlayers Int         @default(0) @map("current_players")
  shoeNumber     Int         @default(1) @map("shoe_number")
  roundNumber    Int         @default(0) @map("round_number")
  bankerWins     Int         @default(0) @map("banker_wins")
  playerWins     Int         @default(0) @map("player_wins")
  tieCount       Int         @default(0) @map("tie_count")
  sortOrder      Int         @default(0) @map("sort_order")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  gameRounds         GameRound[]
  dragonTigerRounds  DragonTigerRound[]
  bullBullRounds     BullBullRound[]
  gameTableState     GameTableState?

  @@index([gameType, isActive])
  @@map("game_tables")
}

// 限紅設定
model BettingLimit {
  id        String   @id @default(uuid())
  name      String
  playerMin Decimal  @map("player_min") @db.Decimal(15, 2)
  playerMax Decimal  @map("player_max") @db.Decimal(15, 2)
  bankerMin Decimal  @map("banker_min") @db.Decimal(15, 2)
  bankerMax Decimal  @map("banker_max") @db.Decimal(15, 2)
  tieMin    Decimal  @map("tie_min") @db.Decimal(15, 2)
  tieMax    Decimal  @map("tie_max") @db.Decimal(15, 2)
  pairMin   Decimal  @map("pair_min") @db.Decimal(15, 2)
  pairMax   Decimal  @map("pair_max") @db.Decimal(15, 2)
  isDefault Boolean  @default(false) @map("is_default")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users User[]

  @@map("betting_limits")
}

// 關注荷官
model DealerFollow {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  user       User     @relation(fields: [userId], references: [id])
  dealerName String   @map("dealer_name")
  createdAt  DateTime @default(now()) @map("created_at")

  @@unique([userId, dealerName])
  @@map("dealer_follows")
}

// 通知設置
model NotificationSettings {
  id                      String   @id @default(uuid())
  userId                  String   @unique @map("user_id")
  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  settlementNotifications Boolean  @default(true) @map("settlement_notifications")
  balanceAlerts           Boolean  @default(true) @map("balance_alerts")
  systemAnnouncements     Boolean  @default(true) @map("system_announcements")
  soundEffects            Boolean  @default(false) @map("sound_effects")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  @@map("notification_settings")
}

// 代理佔成/退水設定表 (按遊戲類別和平台)
model AgentShareSetting {
  id            String   @id @default(uuid())
  agentId       String   @map("agent_id")
  agent         User     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  gameCategory  String   @map("game_category")  // 電子、真人百家1館、真人百家2館、體育
  platform      String                          // 具體平台名稱
  sharePercent  Decimal  @default(0) @map("share_percent") @db.Decimal(5, 2)
  rebatePercent Decimal  @default(0) @map("rebate_percent") @db.Decimal(5, 2)
  enabled       Boolean  @default(true)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([agentId, gameCategory, platform])
  @@map("agent_share_settings")
}

// 代理限紅設定表
model AgentBetLimit {
  id          String   @id @default(uuid())
  agentId     String   @map("agent_id")
  agent       User     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  limitRange  String   @map("limit_range")  // "100-1000", "100-3000" 等
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([agentId, limitRange])
  @@map("agent_bet_limits")
}

// 子帳號表
model SubAccount {
  id          String     @id @default(uuid())
  parentId    String     @map("parent_id")
  parent      User       @relation(fields: [parentId], references: [id], onDelete: Cascade)
  username    String     @unique
  password    String
  nickname    String?
  permissions Json?      // 權限設定
  status      UserStatus @default(active)
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  @@map("sub_accounts")
}

// 佔成/退水變更歷史記錄
model ShareSettingHistory {
  id            String   @id @default(uuid())
  agentId       String   @map("agent_id")
  operatorId    String   @map("operator_id")
  changeType    String   @map("change_type")  // share 或 rebate
  oldValue      Decimal  @map("old_value") @db.Decimal(5, 2)
  newValue      Decimal  @map("new_value") @db.Decimal(5, 2)
  gameCategory  String   @map("game_category")
  platform      String
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("share_setting_histories")
}

// 登入日誌
model LoginLog {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ipAddress  String   @map("ip_address")
  userAgent  String?  @map("user_agent")
  success    Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("login_logs")
}

// 現金日誌 (記錄額度變動)
model CashLog {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  operatorId    String   @map("operator_id")
  changeType    String   @map("change_type")  // deposit, withdraw, transfer
  amount        Decimal  @db.Decimal(15, 2)
  balanceBefore Decimal  @map("balance_before") @db.Decimal(15, 2)
  balanceAfter  Decimal  @map("balance_after") @db.Decimal(15, 2)
  note          String?
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("cash_logs")
}

// Multi-table state persistence
model GameTableState {
  id             String    @id @default(uuid())
  tableId        String    @unique @map("table_id")
  table          GameTable @relation(fields: [tableId], references: [id])
  gameType       String    @map("game_type")
  shoeNumber     Int       @default(1) @map("shoe_number")
  roundCounter   Int       @default(0) @map("round_counter")
  cardsRemaining Int       @default(416) @map("cards_remaining")
  shuffledDeck   Json?     @map("shuffled_deck")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@map("game_table_states")
}

// 遊戲平台配置
model GamePlatform {
  id           String   @id @default(uuid())
  category     String                          // 電子、真人百家1館、真人百家2館、體育
  platformCode String   @unique @map("platform_code")
  platformName String   @map("platform_name")
  isActive     Boolean  @default(true) @map("is_active")
  sortOrder    Int      @default(0) @map("sort_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("game_platforms")
}

// 手動偵測控制（自動偵測）
enum DetectionScope {
  all
  agent_line
  member
}

model ManualDetectionControl {
  id                   String          @id @default(uuid())
  scope                DetectionScope  // 控制範圍：全盤、代理線、會員
  targetAgentId        String?         @map("target_agent_id")
  targetAgentUsername  String?         @map("target_agent_username")
  targetMemberUsername String?         @map("target_member_username")
  targetSettlement     Decimal         @map("target_settlement") @db.Decimal(15, 2)
  controlPercentage    Int             @map("control_percentage")  // 控制機率 1-100
  startSettlement      Decimal         @default(0) @map("start_settlement") @db.Decimal(15, 2)
  isActive             Boolean         @default(true) @map("is_active")
  isCompleted          Boolean         @default(false) @map("is_completed")
  completedAt          DateTime?       @map("completed_at")
  completionSettlement Decimal?        @map("completion_settlement") @db.Decimal(15, 2)
  operatorId           String          @map("operator_id")
  operatorUsername     String?         @map("operator_username")
  createdAt            DateTime        @default(now()) @map("created_at")
  updatedAt            DateTime        @updatedAt @map("updated_at")

  @@index([scope, isActive])
  @@index([targetAgentId, isActive])
  @@map("manual_detection_controls")
}
